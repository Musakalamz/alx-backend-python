#!/usr/bin/env bash
set -euo pipefail

# apply blue and green deployments
kubectl apply -f messaging_app/blue_deployment.yaml || minikube kubectl -- apply -f messaging_app/blue_deployment.yaml
kubectl apply -f messaging_app/green_deployment.yaml || minikube kubectl -- apply -f messaging_app/green_deployment.yaml
kubectl apply -f messaging_app/kubeservice.yaml || minikube kubectl -- apply -f messaging_app/kubeservice.yaml

# verify pods
kubectl get pods || minikube kubectl -- get pods -A

# check logs for green deployment
GREEN_POD=$(kubectl get pods -l app=messaging-app,color=green -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true)
if [ -n "$GREEN_POD" ]; then
  kubectl logs "$GREEN_POD" --tail=100 || true
else
  minikube kubectl -- get pods -l app=messaging-app,color=green -o name
fi
