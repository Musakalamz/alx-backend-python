#!/usr/bin/env bash
set -euo pipefail

kubectl apply -f messaging_app/blue_deployment.yaml || minikube kubectl -- apply -f messaging_app/blue_deployment.yaml

kubectl rollout status deployment/messaging-app-blue || minikube kubectl -- rollout status deployment/messaging-app-blue

URL=${URL:-http://messaging-app:8000/}
for i in $(seq 1 20); do
  curl -s -o /dev/null -w "%{http_code}\n" "$URL" || true
  sleep 1
done

kubectl get pods -l app=messaging-app,color=blue || minikube kubectl -- get pods -l app=messaging-app,color=blue
